<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Integration - Ifá-Lang Use Cases</title>
    <style>
        :root {
            --bg-dark: #0f0f1a;
            --bg-card: #1a1a2e;
            --accent: #e94560;
            --gold: #ffd700;
            --text: #eaeaea;
            --text-dim: #a0a0a0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            line-height: 1.7;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1 {
            color: var(--gold);
            font-size: 2.5rem;
        }

        h2 {
            color: var(--gold);
            margin: 2.5rem 0 1rem;
            border-bottom: 1px solid var(--accent);
            padding-bottom: 0.5rem;
        }

        h3 {
            color: var(--accent);
            margin: 1.5rem 0 0.5rem;
        }

        p {
            margin: 1rem 0;
        }

        pre {
            background: #0d1321;
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        code {
            font-family: 'Consolas', 'Monaco', monospace;
            color: var(--gold);
        }

        a {
            color: var(--gold);
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
            border-top: 1px solid var(--accent);
            margin-top: 3rem;
        }
    </style>
</head>


    <!-- Breadcrumbs -->
    <div class="breadcrumbs">
        <div class="breadcrumbs-container">
            <ul class="breadcrumb-list">
                <!-- Breadcrumbs will be generated by JavaScript -->
            </ul>
        </div>
    </div>
    <div class="container">
        <h1>??? Database Integration</h1>
        <p>Connect to SQLite, PostgreSQL, and use OduStore for embedded storage.</p>

        <h2>SQLite with Odi</h2>
        <p>Ifá-Lang uses <code>rusqlite</code> (bundled) for SQLite support via the Odi domain.</p>

        <pre><code>// Connect to SQLite database
ayanmo db = Odi.db_open("myapp.db");

// Create table
Odi.db_exec(db, "
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        email TEXT UNIQUE,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
");

// Insert data
Odi.db_exec(db, "INSERT INTO users (name, email) VALUES (?, ?)", 
    ["Alice", "alice@example.com"]);

// Query data
ayanmo users = Odi.db_query(db, "SELECT * FROM users WHERE name LIKE ?", ["%li%"]);
fun user ninu users {
    Irosu.fo("User: " + user["name"] + " <" + user["email"] + ">");
}

// Close connection
Odi.db_close(db);</code></pre>

        <h2>PostgreSQL</h2>
        <p>For PostgreSQL, use the Backend stack which provides ORM capabilities.</p>

        <pre><code>// PostgreSQL connection
ayanmo config = {
    "host": Ogbe.env("DB_HOST"),
    "port": 5432,
    "user": Ogbe.env("DB_USER"),
    "password": Ogbe.env("DB_PASSWORD"),
    "database": "myapp"
};

ayanmo pool = Backend.db_pool(config, 10);  // 10 connections

// Query with connection from pool
?b? conn = Backend.db_connect(pool);
ayanmo results = Backend.db_query(conn, "
    SELECT id, name, email 
    FROM users 
    WHERE active = $1
", [otito]);

fun row ninu results {
    Irosu.fo(row["name"]);
}</code></pre>

        <h2>OduStore (Embedded KV)</h2>
        <p>For simple key-value storage without external dependencies, use OduStore from infra.</p>

        <pre><code>// Open or create store
ayanmo store = OduStore.open("data/sessions.odu");

// Store session data
ayanmo session = {
    "user_id": 123,
    "expires": Iwori.now() + 3600,
    "data": {"theme": "dark"}
};
store.set("session:abc123", session);

// Retrieve
ayanmo saved = store.get("session:abc123");
Irosu.fo("User ID: " + saved["user_id"]);

// Delete expired sessions
fun key ninu store.keys() {
    ti (Ika.starts_with(key, "session:")) {
        ayanmo sess = store.get(key);
        ti (sess["expires"] < Iwori.now()) {
            store.delete(key);
        }
    }
}

// Compact when stale ratio is high
ti (store.stale_ratio() > 0.5) {
    store.compact();
}</code></pre>

        <h2>Migrations</h2>
        <pre><code>// Simple migration system
ayanmo migrations = [
    {
        "version": 1,
        "up": "CREATE TABLE users (id INTEGER PRIMARY KEY, name TEXT)",
        "down": "DROP TABLE users"
    },
    {
        "version": 2,
        "up": "ALTER TABLE users ADD COLUMN email TEXT",
        "down": "ALTER TABLE users DROP COLUMN email"
    }
];

ise run_migrations(db, migrations) {
    // Create migrations table
    Odi.db_exec(db, "CREATE TABLE IF NOT EXISTS _migrations (version INTEGER)");
    
    ayanmo current = Odi.db_query(db, "SELECT MAX(version) as v FROM _migrations");
    ayanmo current_version = current[0]["v"];
    ti (current_version == nil) { ayanmo current_version = 0; }
    
    fun m ninu migrations {
        ti (m["version"] > current_version) {
            Irosu.fo("Running migration " + m["version"]);
            Odi.db_exec(db, m["up"]);
            Odi.db_exec(db, "INSERT INTO _migrations (version) VALUES (?)", [m["version"]]);
        }
    }
}

run_migrations(db, migrations);</code></pre>

        <h2>Best Practices</h2>
        <ul style="margin-left: 1.5rem;">
            <li><strong>Use ?b?</strong> — Wrap connections in <code>?b?</code> for automatic cleanup</li>
            <li><strong>Parameterize queries</strong> — Never concatenate user input into SQL</li>
            <li><strong>Connection pooling</strong> — Use pools for PostgreSQL in production</li>
            <li><strong>Compact OduStore</strong> — Run compaction during low-traffic periods</li>
        </ul>

        <footer class="doc-footer">
            <p><a href="../../index.html">? Use Cases</a> · <a href="cloud.html">Cloud Deployment ?</a></p>
            <p><a href="../../index.html">Documentation Home</a></p>
        </footer>
    </div>
    <script src="../../js/nav.js"></script>
    <script src="../../js/common.js"></script>
</body>

</html>

