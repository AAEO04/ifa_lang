<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ìgbálẹ̀ Sandbox & Ọ̀fún Capabilities - Ifá-Lang Documentation</title>
    <style>
        :root {
            --primary: #8B4513;
            --secondary: #D2691E;
            --bg: #FFF8DC;
            --text: #2F1810;
            --code-bg: #F5DEB3;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        h1 {
            color: var(--primary);
            border-bottom: 3px solid var(--secondary);
        }

        h2 {
            color: var(--secondary);
            margin-top: 30px;
        }

        h3 {
            color: var(--primary);
        }

        code {
            background: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
        }

        pre {
            background: var(--code-bg);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border-left: 4px solid var(--secondary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th,
        td {
            border: 1px solid var(--secondary);
            padding: 10px;
            text-align: left;
        }

        th {
            background: var(--secondary);
            color: white;
        }

        tr:nth-child(even) {
            background: rgba(210, 105, 30, 0.1);
        }

        .banner {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }

        .feature-box {
            background: white;
            border: 2px solid var(--secondary);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .warning {
            background: #FFF3CD;
            border-left: 4px solid #FFC107;
            padding: 15px;
            margin: 15px 0;
        }

        .success {
            background: #D4EDDA;
            border-left: 4px solid #28A745;
            padding: 15px;
            margin: 15px 0;
        }

        .info {
            background: #D1ECF1;
            border-left: 4px solid #17A2B8;
            padding: 15px;
            margin: 15px 0;
        }

        .architecture-diagram {
            background: white;
            border: 2px solid var(--primary);
            padding: 20px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <div class="banner">
        <h1>🏺 ÌGBÁLẸ̀ SANDBOX & Ọ̀FÚN CAPABILITIES</h1>
        <p>Unified Security System for Ifá-Lang</p>
        <p><em>Defense in Depth with Capability-Based Permissions</em></p>
    </div>

    <h2>Overview</h2>
    <p>
        Ifá-Lang uses a <strong>layered security model</strong> combining the Ìgbálẹ̀ (Sacred Ground) sandbox
        with the Ọ̀fún capability system. This provides multiple levels of protection:
    </p>

    <div class="architecture-diagram">
        ┌─────────────────────────────────────────────────┐
        │ ifa run script.ifa │
        │ --allow-read=./data --allow-net=api.com │
        │ │ │
        │ ┌──────────┴───────────┐ │
        │ ▼ ▼ │
        │ ┌──────────┐ ┌──────────┐ │
        │ │ OmniBox │ │ Igbale │ │
        │ │ (WASM) │ │ (Native) │ │
        │ └────┬─────┘ └────┬─────┘ │
        │ │ │ │
        │ └───────────┬───────────┘ │
        │ ▼ │
        │ ┌───────────────┐ │
        │ │ CapabilitySet │ (Ọ̀fún permissions) │
        │ └───────────────┘ │
        │ │ │
        │ ▼ │
        │ ┌───────────────┐ │
        │ │ Interpreter │ (Runtime checks) │
        │ └───────────────┘ │
        └─────────────────────────────────────────────────┘
    </div>

    <h2>CLI Permission Flags</h2>
    <p>Control script permissions directly from the command line:</p>
    <pre><code># Run with specific permissions
ifa run script.ifa --allow-read=./data --allow-write=./output

# Allow network to specific domains
ifa run server.ifa --allow-net=api.example.com --allow-net=cdn.example.com

# Environment access
ifa run config.ifa --allow-env=HOME --allow-env=PATH

# All permissions (use with caution!)
ifa run trusted.ifa --allow-all</code></pre>

    <h2>Ọ̀fún Capability Types</h2>
    <table>
        <tr>
            <th>Capability</th>
            <th>CLI Flag</th>
            <th>Description</th>
            <th>Default</th>
        </tr>
        <tr>
            <td><code>ReadFiles</code></td>
            <td><code>--allow-read=PATH</code></td>
            <td>Read files under specified path</td>
            <td>Script dir only</td>
        </tr>
        <tr>
            <td><code>WriteFiles</code></td>
            <td><code>--allow-write=PATH</code></td>
            <td>Write files under specified path</td>
            <td>❌ Denied</td>
        </tr>
        <tr>
            <td><code>Network</code></td>
            <td><code>--allow-net=DOMAIN</code></td>
            <td>HTTP/TCP to specified domains</td>
            <td>❌ Denied</td>
        </tr>
        <tr>
            <td><code>Environment</code></td>
            <td><code>--allow-env=KEY</code></td>
            <td>Access environment variables</td>
            <td>❌ Denied</td>
        </tr>
        <tr>
            <td><code>Time</code></td>
            <td><code>--allow-time</code></td>
            <td>Access system time</td>
            <td>❌ Denied</td>
        </tr>
        <tr>
            <td><code>Random</code></td>
            <td><code>--allow-random</code></td>
            <td>Generate random numbers</td>
            <td>✅ Allowed</td>
        </tr>
        <tr>
            <td><code>Stdio</code></td>
            <td><code>--allow-stdio</code></td>
            <td>Console input/output</td>
            <td>✅ Allowed</td>
        </tr>
        <tr>
            <td><code>Execute</code></td>
            <td><code>--allow-run=PROG</code></td>
            <td>Spawn subprocesses</td>
            <td>❌ Denied</td>
        </tr>
    </table>

    <h2>Sandbox Backends</h2>

    <h3>1. Native Execution + Capability Checks</h3>
    <div class="feature-box">
        <p><strong>Default mode.</strong> The interpreter enforces Ọ̀fún capabilities at runtime:</p>
        <pre><code># This will fail without --allow-read=/etc
Odi.ka("/etc/passwd")  # CapabilityDenied: ReadFiles</code></pre>
    </div>

    <h3>2. Ìgbálẹ̀ OS Sandbox</h3>
    <div class="feature-box">
        <p><strong>OS-level isolation</strong> for untrusted code:</p>
        <ul>
            <li><strong>Linux:</strong> <code>unshare</code> + namespaces + cgroups</li>
            <li><strong>macOS:</strong> <code>sandbox-exec</code> profiles</li>
            <li><strong>Windows:</strong> Job Objects (basic isolation)</li>
        </ul>
        <pre><code># Force OS sandbox
ifa run --sandbox=native untrusted.ifa --timeout=30</code></pre>
    </div>

    <h3>3. OmniBox WASM Sandbox</h3>
    <div class="feature-box">
        <p><strong>WebAssembly isolation</strong> via Wasmtime:</p>
        <pre><code># Run as WASM module (requires compiled .wasm)
ifa run --sandbox=wasm module.wasm --allow-read=./data</code></pre>
        <p>WASM provides the strongest isolation but requires compilation.</p>
    </div>

    <h2>Security Architecture (16 Odù)</h2>
    <table>
        <tr>
            <th>Odù</th>
            <th>Component</th>
            <th>Function</th>
        </tr>
        <tr>
            <td>Ogbè</td>
            <td>Lifecycle</td>
            <td>Container create/start/stop</td>
        </tr>
        <tr>
            <td>Ọ̀yẹ̀kú</td>
            <td>Terminator</td>
            <td>Graceful shutdown &amp; cleanup</td>
        </tr>
        <tr>
            <td>Ìwòrì</td>
            <td>TimeGuard</td>
            <td>Execution timeouts (Ọ̀fún::Time)</td>
        </tr>
        <tr>
            <td>Òdí</td>
            <td>FileGuard</td>
            <td>Filesystem isolation (Ọ̀fún::ReadFiles/WriteFiles)</td>
        </tr>
        <tr>
            <td>Ìrosù</td>
            <td>IoGuard</td>
            <td>Stdio capture (Ọ̀fún::Stdio)</td>
        </tr>
        <tr>
            <td>Ọ̀wọ́nrín</td>
            <td>EntropyGuard</td>
            <td>Isolated CSPRNG (Ọ̀fún::Random)</td>
        </tr>
        <tr>
            <td>Ọ̀sá</td>
            <td>NetGuard</td>
            <td>Network filtering (Ọ̀fún::Network)</td>
        </tr>
        <tr>
            <td>Ògúndá</td>
            <td>ProcessGuard</td>
            <td>Subprocess control (Ọ̀fún::Execute)</td>
        </tr>
        <tr>
            <td>Ọ̀fún</td>
            <td>CapabilitySet</td>
            <td>Central permission authority</td>
        </tr>
    </table>

    <h2>Rust API</h2>
    <pre><code>use ifa_sandbox::{CapabilitySet, Ofun};

// Create capability set
let mut caps = CapabilitySet::new();
caps.grant(Ofun::ReadFiles { root: PathBuf::from("./data") });
caps.grant(Ofun::Network { domains: vec!["api.example.com".into()] });
caps.grant(Ofun::Stdio);

// Check permissions
if caps.check(&Ofun::ReadFiles { root: PathBuf::from("./data/file.txt") }) {
    // Access allowed
}

// Use with interpreter
let mut interp = Interpreter::new();
interp.set_capabilities(caps);
interp.run_file("script.ifa")?;</code></pre>

    <h2>Defense in Depth</h2>
    <div class="success">
        <strong>Multiple Layers:</strong> Even if one protection is bypassed, others remain active.
    </div>

    <table>
        <tr>
            <th>Threat</th>
            <th>Layer 1: Capability Check</th>
            <th>Layer 2: Sandbox</th>
        </tr>
        <tr>
            <td>Unauthorized file read</td>
            <td>Ọ̀fún::ReadFiles denied</td>
            <td>VFS chroot jail</td>
        </tr>
        <tr>
            <td>Network exfiltration</td>
            <td>Ọ̀fún::Network denied</td>
            <td>Network namespace isolation</td>
        </tr>
        <tr>
            <td>Env secret theft</td>
            <td>Ọ̀fún::Environment denied</td>
            <td>Sanitized environment</td>
        </tr>
        <tr>
            <td>Fork bomb</td>
            <td>Ọ̀fún::Execute denied</td>
            <td>Process limit (max 10)</td>
        </tr>
        <tr>
            <td>Infinite loop</td>
            <td>-</td>
            <td>Watchdog timeout</td>
        </tr>
    </table>

    <h2>Best Practices</h2>
    <div class="info">
        <h3>🔒 Principle of Least Privilege</h3>
        <p>Only grant the permissions your script actually needs:</p>
        <pre><code># BAD: Too permissive
ifa run script.ifa --allow-all

# GOOD: Specific permissions
ifa run script.ifa --allow-read=./config.json --allow-net=api.myapp.com</code></pre>
    </div>

    <div class="warning">
        <h3>⚠️ The <code>--allow-all</code> Flag</h3>
        <p>
            Only use <code>--allow-all</code> for your own trusted scripts. It grants:
            file access to entire filesystem, network access everywhere, all env vars, etc.
        </p>
    </div>

    <h2>Opon (Memory) Variable Sizing</h2>
    <div class="info">
        <strong>📦 Opon = The Sacred Calabash</strong> - The memory container for the Ifá-Lang VM.
        Size is configurable for different deployment scenarios.
    </div>

    <table>
        <tr>
            <th>Preset</th>
            <th>Slots</th>
            <th>Memory</th>
            <th>Use Case</th>
        </tr>
        <tr>
            <td><code>Kekere</code></td>
            <td>256</td>
            <td>~4KB</td>
            <td>Embedded systems, microcontrollers</td>
        </tr>
        <tr>
            <td><code>Arinrin</code></td>
            <td>4,096</td>
            <td>~64KB</td>
            <td>Standard (default)</td>
        </tr>
        <tr>
            <td><code>Nla</code></td>
            <td>65,536</td>
            <td>~1MB</td>
            <td>Large workloads</td>
        </tr>
        <tr>
            <td><code>Ailopin</code></td>
            <td>Dynamic</td>
            <td>Grows as needed</td>
            <td>Unlimited (server/desktop)</td>
        </tr>
    </table>

    <pre><code># Set Opon size via directive
#opon nla

# Or in embedded config
let config = EmbeddedConfig { opon_size: 256 };</code></pre>

    <h2>Security Analysis: VM Escape Vectors</h2>
    <div class="warning">
        <strong>⚠️ Can pointer attacks escape the VM?</strong>
    </div>

    <table>
        <tr>
            <th>Attack Vector</th>
            <th>Protection</th>
            <th>Status</th>
        </tr>
        <tr>
            <td>Raw pointer manipulation</td>
            <td>No pointers exposed to scripts</td>
            <td style="color: #28a745;">✅ Safe</td>
        </tr>
        <tr>
            <td>Buffer overflow</td>
            <td>Rust memory safety + bounds checking</td>
            <td style="color: #28a745;">✅ Safe</td>
        </tr>
        <tr>
            <td>Use-after-free</td>
            <td>Rc&lt;RefCell&gt; ownership model</td>
            <td style="color: #28a745;">✅ Safe</td>
        </tr>
        <tr>
            <td>Type confusion</td>
            <td>IfaValue enum is type-safe</td>
            <td style="color: #28a745;">✅ Safe</td>
        </tr>
        <tr>
            <td>WASM escape</td>
            <td>Wasmtime hardware sandbox</td>
            <td style="color: #28a745;">✅ Very Safe</td>
        </tr>
        <tr>
            <td><strong>FFI Library Loading</strong></td>
            <td>Requires Ọ̀fún::Execute capability</td>
            <td style="color: #ffc107;">⚠️ Mitigated</td>
        </tr>
    </table>

    <div class="feature-box">
        <h3>🔐 FFI Security Hardening</h3>
        <p>FFI is the only potential escape vector. Mitigations:</p>
        <ul>
            <li><strong>Capability Required:</strong> FFI calls require <code>Ọ̀fún::Execute</code> (denied by default)
            </li>
            <li><strong>Whitelist Mode:</strong> Only approved libraries can be loaded</li>
            <li><strong>No <code>--allow-all</code>:</strong> Never use in production with untrusted code</li>
        </ul>
        <pre><code># Safe invocation (FFI blocked)
ifa run untrusted.ifa

# Only if you FULLY trust the code
ifa run trusted.ifa --allow-run=libsafe.dll</code></pre>
    </div>

    <hr>
    <p style="text-align: center; color: #888;">
        Ìgbálẹ̀ Sandbox & Ọ̀fún Capabilities &bull; Ifá-Lang &copy; 2025-2026 Ayomide Alli (Charon)
    </p>
</body>

</html>