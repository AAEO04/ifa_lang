<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Infrastructure - Ifá-Lang</title>
    <style>
        :root {
            --bg-dark: #0f0f1a;
            --bg-card: #1a1a2e;
            --accent: #e94560;
            --gold: #ffd700;
            --text: #eaeaea;
            --text-dim: #a0a0a0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            line-height: 1.7;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        h1 {
            color: var(--gold);
            font-size: 2.5rem;
        }

        h2 {
            color: var(--gold);
            margin: 2.5rem 0 1rem;
            border-bottom: 1px solid var(--accent);
            padding-bottom: 0.5rem;
        }

        p {
            margin: 1rem 0;
        }

        pre {
            background: #0d1321;
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        code {
            font-family: 'Consolas', 'Monaco', monospace;
            color: var(--gold);
        }

        .api-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .api-card h4 {
            color: var(--gold);
            margin: 0 0 0.5rem;
            font-family: monospace;
        }

        a {
            color: var(--gold);
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-dim);
            border-top: 1px solid var(--accent);
            margin-top: 3rem;
        }
    </style>
</head>


    <!-- Breadcrumbs -->
    <div class="breadcrumbs">
        <div class="breadcrumbs-container">
            <ul class="breadcrumb-list">
                <!-- Breadcrumbs will be generated by JavaScript -->
            </ul>
        </div>
    </div>
    <div class="container">
        <h1>?? Storage Infrastructure</h1>
        <p>OduStore: High-performance append-only key-value database.</p>
        <p><strong>Source:</strong> <code>crates/ifa-std/src/infra/storage.rs</code> (490 lines)</p>

        <h2>OduStore</h2>
        <p>A native, append-only key-value database with CRC32 checksums and log compaction.</p>

        <h3>File Format</h3>
        <pre><code>// Format v2:
[MAGIC: 4 bytes][VERSION: 1 byte][Records...]

// Each Record:
[CRC32: 4 bytes][Type: 1 byte][KeyLen: 4 bytes][Key][ValLen: 4 bytes][Value]</code></pre>

        <h2>Core API</h2>

        <div class="api-card">
            <h4>OduStore.open(path) ? Result&lt;Self, StorageError&gt;</h4>
            <p>Open or create a store at the given path. Replays log to rebuild index.</p>
            <pre><code>ayanmo store = OduStore.open("data/myapp.odu");
ti (Okanran.is_error(store)) {
    Irosu.kigbe("Failed to open store: " + Okanran.message(store));
}</code></pre>
        </div>

        <div class="api-card">
            <h4>OduStore.set(key, value) ? Result&lt;(), StorageError&gt;</h4>
            <p>Set a key-value pair. Value is automatically serialized.</p>
            <pre><code>store.set("user:123", {"name": "Alice", "age": 30});
store.set("counter", 42);
store.set("active", otito);</code></pre>
        </div>

        <div class="api-card">
            <h4>OduStore.get(key) ? Result&lt;V, StorageError&gt;</h4>
            <p>Get a value by key. Returns error if key not found.</p>
            <pre><code>ayanmo user = store.get("user:123");
Irosu.fo("Name: " + user["name"]);</code></pre>
        </div>

        <div class="api-card">
            <h4>OduStore.delete(key) ? Result&lt;bool, StorageError&gt;</h4>
            <p>Delete a key. Returns true if key existed.</p>
            <pre><code>ayanmo deleted = store.delete("user:123");
ti (deleted) {
    Irosu.fo("User deleted");
}</code></pre>
        </div>

        <div class="api-card">
            <h4>OduStore.contains_key(key) ? bool</h4>
            <p>Check if a key exists.</p>
            <pre><code>ti (store.contains_key("user:123")) {
    Irosu.fo("User exists");
}</code></pre>
        </div>

        <div class="api-card">
            <h4>OduStore.keys() ? Iterator&lt;String&gt;</h4>
            <p>Get all keys in the store.</p>
            <pre><code>fun key ninu store.keys() {
    Irosu.fo("Key: " + key);
}</code></pre>
        </div>

        <div class="api-card">
            <h4>OduStore.len() ? usize</h4>
            <p>Get number of live keys.</p>
        </div>

        <div class="api-card">
            <h4>OduStore.is_empty() ? bool</h4>
            <p>Check if store is empty.</p>
        </div>

        <h2>Compaction</h2>

        <div class="api-card">
            <h4>OduStore.stale_ratio() ? f64</h4>
            <p>Get ratio of stale records (for compaction decision).</p>
            <pre><code>ti (store.stale_ratio() > 0.5) {
    // More than 50% stale, compact
    store.compact();
}</code></pre>
        </div>

        <div class="api-card">
            <h4>OduStore.compact() ? Result&lt;(), StorageError&gt;</h4>
            <p>Compact the log by rewriting only live entries. Creates new file, writes current key-value pairs,
                atomically swaps.</p>
            <pre><code>// Periodic compaction
ti (store.stale_ratio() > 0.3) {
    Irosu.fo("Compacting store...");
    store.compact();
    Irosu.fo("Compaction complete");
}</code></pre>
        </div>

        <h2>Error Handling</h2>
        <pre><code>// StorageError variants:
// - IoError(String)
// - KeyNotFound(String)
// - SerializationError(String)
// - CorruptedLog(String)
// - ChecksumMismatch { expected, actual }
// - InvalidFormat

ayanmo result = store.get("missing_key");
ti (Okanran.is_error(result)) {
    ayanmo err = Okanran.error_type(result);
    ti (err == "KeyNotFound") {
        Irosu.fo("Key not found, using default");
    }
}</code></pre>

        <h2>Use Cases</h2>
        <ul style="margin-left: 1.5rem;">
            <li><strong>Session storage</strong> — Store user sessions with automatic cleanup</li>
            <li><strong>Caching</strong> — Persistent cache that survives restarts</li>
            <li><strong>Configuration</strong> — Store app settings</li>
            <li><strong>Embedded database</strong> — No external dependencies</li>
        </ul>

        <footer class="doc-footer">
            <p><a href="gpu.html">? GPU</a> · <a href="kernel.html">Kernel ?</a></p>
            <p><a href="../../index.html">Documentation Home</a></p>
        </footer>
    </div>
    <script src="../../js/nav.js"></script>
    <script src="../../js/common.js"></script>
</body>

</html>

