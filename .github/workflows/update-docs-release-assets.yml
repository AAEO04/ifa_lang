# Updates docs/*.html download links to point at the released installer assets
# Runs when a release is published.

name: Update Docs Release Assets

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get release info
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          
          # Find Windows installer
          WINDOWS_URL=$(gh release view "$TAG" --json assets -q '.assets[] | select(.name | test("ifa-installer.*windows.*\\.exe$")) | .url' | head -1)
          echo "windows_url=$WINDOWS_URL" >> $GITHUB_OUTPUT
          
          # Find Linux binary (for curl | sh)
          LINUX_URL=$(gh release view "$TAG" --json assets -q '.assets[] | select(.name | test("^ifa-.*linux-x86_64$")) | .url' | head -1)
          echo "linux_url=$LINUX_URL" >> $GITHUB_OUTPUT
          
          # Find macOS ARM binary
          MACOS_ARM_URL=$(gh release view "$TAG" --json assets -q '.assets[] | select(.name | test("^ifa-.*macos-arm64$")) | .url' | head -1)
          echo "macos_arm_url=$MACOS_ARM_URL" >> $GITHUB_OUTPUT
          
          # Find macOS Intel binary
          MACOS_INTEL_URL=$(gh release view "$TAG" --json assets -q '.assets[] | select(.name | test("^ifa-.*macos-x86_64$")) | .url' | head -1)
          echo "macos_intel_url=$MACOS_INTEL_URL" >> $GITHUB_OUTPUT
          
          echo "Found Windows installer: $WINDOWS_URL"
          echo "Found Linux: $LINUX_URL"
          echo "Found macOS ARM: $MACOS_ARM_URL"
          echo "Found macOS Intel: $MACOS_INTEL_URL"

      - name: Update docs with new asset URLs
        env:
          TAG: ${{ steps.release.outputs.tag }}
          WINDOWS_URL: ${{ steps.release.outputs.windows_url }}
          LINUX_URL: ${{ steps.release.outputs.linux_url }}
          MACOS_ARM_URL: ${{ steps.release.outputs.macos_arm_url }}
          MACOS_INTEL_URL: ${{ steps.release.outputs.macos_intel_url }}
        run: |
          echo "Updating docs for release $TAG"
          
          for file in docs/*.html; do
            if [ -f "$file" ]; then
              echo "Processing $file..."
              
              # Update Windows installer download link
              if [ -n "$WINDOWS_URL" ]; then
                sed -i -E "s|https://github.com/AAEO04/ifa_lang/releases/download/[^/]+/ifa-installer[^\"]*\.exe|$WINDOWS_URL|g" "$file"
              fi
              
              # Update Linux download link
              if [ -n "$LINUX_URL" ]; then
                sed -i -E "s|https://github.com/AAEO04/ifa_lang/releases/download/[^/]+/ifa-[^\"]*linux-x86_64|$LINUX_URL|g" "$file"
              fi
              
              # Update macOS ARM download link
              if [ -n "$MACOS_ARM_URL" ]; then
                sed -i -E "s|https://github.com/AAEO04/ifa_lang/releases/download/[^/]+/ifa-[^\"]*macos-arm64|$MACOS_ARM_URL|g" "$file"
              fi
              
              # Update macOS Intel download link
              if [ -n "$MACOS_INTEL_URL" ]; then
                sed -i -E "s|https://github.com/AAEO04/ifa_lang/releases/download/[^/]+/ifa-[^\"]*macos-x86_64|$MACOS_INTEL_URL|g" "$file"
              fi
              
              # Fallback: Update version tag in any remaining release URLs
              sed -i -E "s|/releases/download/v[0-9]+\.[0-9]+\.[0-9]+/|/releases/download/$TAG/|g" "$file"
            fi
          done
          
          echo "Docs update complete"

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet docs/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in docs"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff docs/
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          git commit -m "docs: Update download links for release ${{ steps.release.outputs.tag }}"
          git push
