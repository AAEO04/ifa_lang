// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT_SERVER.IFA - Multi-Client Chat Server
// Demonstrates networking, concurrent connections, and message broadcasting
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Run: ifa run examples/05_advanced/chat_server.ifa
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ã¬bÃ  Irosu;    // Output
Ã¬bÃ  Otura;    // Network
Ã¬bÃ  Ogunda;   // Arrays
Ã¬bÃ  Ika;      // Strings
Ã¬bÃ  Iwori;    // Time
Ã¬bÃ  Osa;      // Concurrency

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGE CLASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

odÃ¹ Message {
    ayanmá» sender = "";
    ayanmá» content = "";
    ayanmá» timestamp = "";
    
    ese dÃ¡(from, text) {
        sender = from;
        content = text;
        timestamp = Iwori.royin("%H:%M:%S");
    }
    
    ese format() {
        padÃ  Ika.so("[", timestamp, "] ", sender, ": ", content);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHATROOM CLASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

odÃ¹ ChatRoom {
    ayanmá» name = "";
    ayanmá» clients = [];
    ayanmá» history = [];
    ayanmá» max_history = 100;
    
    ese dÃ¡(room_name) {
        name = room_name;
        clients = [];
        history = [];
    }
    
    ese join(client_id, username) {
        ayanmá» client = {
            "id": client_id,
            "name": username
        };
        clients = Ogunda.fi(clients, client);
        
        // Announce to room
        ayanmá» msg = Message.dÃ¡("System", username + " joined the room");
        broadcast(msg);
        
        Irosu.fo("ğŸ‘¤ " + username + " joined " + name);
    }
    
    ese leave(client_id) {
        ayanmá» new_clients = [];
        ayanmá» username = "Unknown";
        
        fun client ninu clients {
            ti client.id == client_id {
                username = client.name;
            } bibáº¹ká» {
                new_clients = Ogunda.fi(new_clients, client);
            }
        }
        
        clients = new_clients;
        
        ayanmá» msg = Message.dÃ¡("System", username + " left the room");
        broadcast(msg);
        
        Irosu.fo("ğŸ‘‹ " + username + " left " + name);
    }
    
    ese send_message(client_id, content) {
        ayanmá» username = get_username(client_id);
        ayanmá» msg = Message.dÃ¡(username, content);
        
        // Add to history
        history = Ogunda.fi(history, msg);
        ti Ogunda.gigun(history) > max_history {
            history = Ogunda.ge(history, 1, max_history);
        }
        
        broadcast(msg);
    }
    
    ese broadcast(message) {
        ayanmá» formatted = message.format();
        
        fun client ninu clients {
            Otura.send_to(client.id, formatted);
        }
    }
    
    ese get_username(client_id) {
        fun client ninu clients {
            ti client.id == client_id {
                padÃ  client.name;
            }
        }
        padÃ  "Anonymous";
    }
    
    ese get_online_count() {
        padÃ  Ogunda.gigun(clients);
    }
    
    ese get_history(limit) {
        ayanmá» len = Ogunda.gigun(history);
        ayanmá» start = len - limit;
        ti start < 0 {
            start = 0;
        }
        padÃ  Ogunda.ge(history, start, len);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT SERVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

odÃ¹ ChatServer {
    ayanmá» port = 8888;
    ayanmá» rooms = {};
    ayanmá» running = iro;
    
    ese dÃ¡(server_port) {
        port = server_port;
        
        // Create default rooms
        rooms["general"] = ChatRoom.dÃ¡("general");
        rooms["random"] = ChatRoom.dÃ¡("random");
        rooms["help"] = ChatRoom.dÃ¡("help");
    }
    
    ese start() {
        Irosu.fo("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
        Irosu.fo("â•‘        IfÃ¡-Lang Chat Server                               â•‘");
        Irosu.fo("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
        
        ti Otura.de(port) {
            running = otito;
            Irosu.fo("ğŸš€ Server started on port " + port);
            Irosu.fo("ğŸ“‹ Available rooms: general, random, help");
            Irosu.fo("â³ Waiting for connections...\n");
            
            accept_loop();
        } bibáº¹ká» {
            Irosu.fo("âŒ Failed to bind to port " + port);
        }
    }
    
    ese accept_loop() {
        nigba running {
            ti Otura.tetisi(1) {
                ayanmá» client_id = Otura.get_client_id();
                Irosu.fo("ğŸ”— New connection: " + client_id);
                
                // Send welcome message
                Otura.send_to(client_id, "Welcome to IfÃ¡-Lang Chat!");
                Otura.send_to(client_id, "Commands: /join <room>, /leave, /rooms, /who, /quit");
                
                // Handle client in background
                Osa.spawn(handle_client, client_id);
            }
        }
    }
    
    ese handle_client(client_id) {
        ayanmá» current_room = "";
        ayanmá» username = "User" + client_id;
        
        nigba otito {
            ayanmá» data = Otura.recv_from(client_id, 1024, 30);
            
            ti Ika.gigun(data) == 0 {
                // Client disconnected
                ti current_room != "" {
                    rooms[current_room].leave(client_id);
                }
                dabá»;
            }
            
            // Parse command
            ti Ika.ge(data, 0, 1) == "/" {
                handle_command(client_id, data, current_room, username);
            } bibáº¹ká» {
                // Regular message
                ti current_room != "" {
                    rooms[current_room].send_message(client_id, data);
                } bibáº¹ká» {
                    Otura.send_to(client_id, "Join a room first: /join <room>");
                }
            }
        }
        
        Irosu.fo("ğŸ”Œ Client disconnected: " + client_id);
    }
    
    ese handle_command(client_id, cmd, room, username) {
        ayanmá» parts = Ika.pin(cmd, " ");
        ayanmá» command = parts[0];
        
        ti command == "/join" {
            ayanmá» room_name = parts[1];
            ti rooms[room_name] {
                rooms[room_name].join(client_id, username);
                Otura.send_to(client_id, "Joined room: " + room_name);
            } bibáº¹ká» {
                Otura.send_to(client_id, "Room not found: " + room_name);
            }
        }
        
        ti command == "/rooms" {
            Otura.send_to(client_id, "Available rooms: general, random, help");
        }
        
        ti command == "/who" {
            ti room != "" {
                ayanmá» count = rooms[room].get_online_count();
                Otura.send_to(client_id, "Users online: " + count);
            }
        }
        
        ti command == "/quit" {
            Otura.close_client(client_id);
        }
    }
    
    ese stop() {
        running = iro;
        Otura.pa();
        Irosu.fo("ğŸ›‘ Server stopped");
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ayanmá» server = ChatServer.dÃ¡(8888);
server.start();

Ã á¹£áº¹;
